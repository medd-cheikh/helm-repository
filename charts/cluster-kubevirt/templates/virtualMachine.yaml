{{- if .Values.vms }}{{- if .Values.vms.enabled }}
{{- $root := . -}}
{{- $defaultns := .Values.project.project.name -}}
{{ range .Values.vms.list }}
{{- $name := .name | default "default-vm" -}}
{{- $cloudInit := .cloudInit | default "name: default\nhostname: {{- $name -}}" -}}
{{- $hostname := .hostname | default "{{- $name -}}.local" -}}
{{- $namespace := .namespace | default $defaultns -}}
{{- $os_signature := .os.signature | default "centos7.0" -}}
{{- $os_name := .os.name | default $os_signature -}}
{{- $disk_boot_type := .storage.boot_type | default "dataVolume" -}}
{{- $disk_boot_image := .storage.boot_image | default "https://cloud.centos.org/centos/7/images/CentOS-7-x86_64-GenericCloud-1907.qcow2" -}}
{{- $disk_boot_size := .storage.boot_size | default "10G" -}}
{{- $disk_boot_storageclass := .storage.boot_storageclass | default "gp2" -}}
---
kind: VirtualMachine
apiVersion: kubevirt.io/v1alpha3
metadata:
  name: {{ $name | quote }}
  namespace: {{ $namespace | quote }}
  labels:
    {{- include "cluster-kubevirt.labels" $root | nindent 4 }}
    app: "{{- $name -}}"
    app.kubernetes.io/name: "{{- $name -}}-virtualmachine"
    flavor.template.kubevirt.io/medium: 'true'
    os.template.kubevirt.io/{{ $os_signature }}: 'true'
    workload.template.kubevirt.io/server: 'true'
  annotations:
    {{- include "cluster-kubevirt.annotations" $root | nindent 4 }}
    argocd.argoproj.io/sync-wave: "50"
    kubevirt.io/latest-observed-api-version: v1alpha3
    kubevirt.io/storage-observed-api-version: v1alpha3
    name.os.template.kubevirt.io/{{ $os_signature }}: {{ $os_name | quote }}
    vm.kubevirt.io/flavor: medium
    vm.kubevirt.io/os: {{ $os_signature }}
    vm.kubevirt.io/workload: server
  finalizers:
    - k8s.v1.cni.cncf.io/kubeMacPool
spec:
  {{- if or (eq $disk_boot_type "dataVolume") .storage.disks }}
  dataVolumeTemplates:
    {{- if eq $disk_boot_type "dataVolume" }}
    - metadata:
        name: "{{- $name -}}-rootdisk"
      spec:
        pvc:
          storageClassName: {{ $disk_boot_storageclass | quote }}
          volumeMode: Filesystem
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: {{ $disk_boot_size }}
        source:
          http:
            url: >-
              {{- $disk_boot_image | nindent 14 }}
      status: {}
    {{- end }}
    {{ range .storage.disks }}
    {{- $disk_name := .name | default "disk0" -}}
    {{- $disk_storageclass := .storageclass | default "gp2" -}}
    {{- $disk_size := .size | default "2G" -}}
    - apiVersion: cdi.kubevirt.io/v1alpha1
      kind: DataVolume
      metadata:
        name: "{{- $name -}}-{{- $disk_name -}}"
      spec:
        pvc:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: {{ $disk_size }}
          storageClassName: {{ $disk_storageclass | quote }}
          volumeMode: Filesystem
        source:
          blank: {}
    {{- end }}
  {{- end }}
  running: true
  template:
    metadata:
      labels:
        {{- include "cluster-kubevirt.labels" $root | nindent 8 }}
        app.kubernetes.io/name: "{{- $name -}}-vminstance"
        app.kubernetes.io/part-of: "{{- $name -}}"
        kubevirt.io/domain: "{{- $name -}}"
        kubevirt.io/size: medium
        flavor.template.kubevirt.io/medium: 'true'
        vm.kubevirt.io/name: "{{- $name -}}"
        os.template.kubevirt.io/{{ $os_signature }}: 'true'
        workload.template.kubevirt.io/server: 'true'
      annotations:
        {{- include "cluster-kubevirt.annotations" $root | nindent 8 }}
    spec:
      hostname: {{ $name | quote }}
      evictionStrategy: LiveMigrate
      domain:
        machine:
          type: ''
        resources:
          requests:
            memory: 1Gi
        cpu:
          cores: 1
          sockets: 1
          threads: 1
        devices:
          disks:
            - name: rootdisk
              bootOrder: 1
              disk:
                bus: virtio
            {{ range .storage.disks }}
            {{- $disk_name := .name | default "disk0" -}}
            {{- $boot_order := .boot_order | default 3 -}}
            - name: {{ $disk_name | quote }}
              bootOrder: {{ $boot_order }}
              disk:
                bus: virtio
            {{ end -}}
            - name: cloudinitdisk
              bootOrder: 10
              disk:
                bus: virtio
          interfaces:
            - name: nic0
              bootOrder: 2
              masquerade: {}
              model: virtio
          networkInterfaceMultiqueue: true
          rng: {}
      networks:
        - name: nic0
          pod: {}
      volumes:
        {{- if eq $disk_boot_type "dataVolume" }}
        - name: rootdisk
          dataVolume:
            name: "{{- $name -}}-rootdisk"
        {{- else }}
        - name: rootdisk
          containerDisk:
            image: {{ $disk_boot_image | quote }}
        {{- end }}
        {{ range .storage.disks }}
        {{- $disk_name := .name | default "disk0" -}}
        - name: "{{- $disk_name -}}"
          dataVolume:
            name: "{{- $name -}}-{{- $disk_name -}}"
        {{ end -}}
        - name: cloudinitdisk
          cloudInitNoCloud:
            userData: |
              {{- $cloudInit | nindent 14 }}
      terminationGracePeriodSeconds: 0
{{ end }}
{{- end }}{{- end }}































apiVersion: kubevirt.io/v1alpha3
kind: VirtualMachine
metadata:
  annotations:
    kubevirt.io/latest-observed-api-version: v1alpha3
    kubevirt.io/storage-observed-api-version: v1alpha3
    kubevirt.ui/firstBoot: 'false'
    name.os.template.kubevirt.io/rhel6.10: Red Hat Enterprise Linux 6.0 or higher
    vm.kubevirt.io/flavor: small
    vm.kubevirt.io/os: rhel6
    vm.kubevirt.io/validations: |
      [
        {
          "name": "minimal-required-memory",
          "path": "jsonpath::.spec.domain.resources.requests.memory",
          "rule": "integer",
          "message": "This VM requires more memory.",
          "min": 536870912
        }
      ]
    vm.kubevirt.io/workload: server
  name: rhel6-passing-hummingbird
  namespace: openshift-storage
  labels:
    app: rhel6-passing-hummingbird
    flavor.template.kubevirt.io/small: 'true'
    os.template.kubevirt.io/rhel6.10: 'true'
    vm.kubevirt.io/template: rhel6-server-small
    vm.kubevirt.io/template.namespace: openshift
    vm.kubevirt.io/template.revision: '1'
    vm.kubevirt.io/template.version: v0.13.2
    workload.template.kubevirt.io/server: 'true'
spec:
  dataVolumeTemplates:
    - apiVersion: cdi.kubevirt.io/v1beta1
      kind: DataVolume
      metadata:
        creationTimestamp: null
        labels:
          kubevirt.ui/cdrom: 'true'
        name: rhel6-passing-hummingbird-rootdisk
      spec:
        pvc:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 20Gi
          storageClassName: gp2
          volumeMode: Filesystem
        source:
          http:
            url: >-
              https://sso.redhat.com/auth/realms/redhat-external/protocol/openid-connect/auth?client_id=rh-product-eval&redirect_uri=https%3A%2F%2Fwww.redhat.com%2Fen%2Ftechnologies%2Flinux-platforms%2Fenterprise-linux%2Ftry-it%2Fsuccess-server&state=24f7a53b-3094-4f54-8fb1-7edf1347eb7b&response_mode=fragment&response_type=code&scope=openid&nonce=ccc92ec8-9b40-44a7-b6fe-7ee48eba8fd2
    - apiVersion: cdi.kubevirt.io/v1beta1
      kind: DataVolume
      metadata:
        creationTimestamp: null
        name: rhel6-passing-hummingbird-rootdisk-install-95vu3
      spec:
        pvc:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 20Gi
          volumeMode: Filesystem
        source:
          blank: {}
  running: true
  template:
    metadata:
      creationTimestamp: null
      labels:
        flavor.template.kubevirt.io/small: 'true'
        kubevirt.io/domain: rhel6-passing-hummingbird
        kubevirt.io/size: small
        os.template.kubevirt.io/rhel6.10: 'true'
        vm.kubevirt.io/name: rhel6-passing-hummingbird
        workload.template.kubevirt.io/server: 'true'
    spec:
      domain:
        cpu:
          cores: 1
          sockets: 1
          threads: 1
        devices:
          disks:
            - bootOrder: 1
              cdrom:
                bus: sata
              name: rhel6-passing-hummingbird
            - bootOrder: 2
              disk:
                bus: sata
              name: rootdisk-install
            - disk:
                bus: sata
              name: cloudinitdisk
          interfaces:
            - masquerade: {}
              model: e1000e
              name: default
          rng: {}
          useVirtioTransitional: true
        machine:
          type: pc-q35-rhel8.3.0
        resources:
          requests:
            memory: 2Gi
      evictionStrategy: LiveMigrate
      hostname: rhel6-passing-hummingbird
      networks:
        - name: default
          pod: {}
      terminationGracePeriodSeconds: 180
      volumes:



